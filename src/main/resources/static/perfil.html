<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil - CryptoTracker</title>
</head>
<body>
  <h2>Editar Perfil</h2>
  <form id="perfilForm">
    <input type="hidden" id="userId" name="id" />
    <label for="nombreUsuario">Nombre de usuario:</label><br />
    <input type="text" id="nombreUsuario" name="nombreUsuario" required /><br /><br />
    <label for="email">Correo electr√≥nico:</label><br />
    <input type="email" id="email" name="email" /><br /><br />
    <label for="nombre">Nombre:</label><br />
    <input type="text" id="nombre" name="nombre" /><br /><br />
    <label for="apellido">Apellido:</label><br />
    <input type="text" id="apellido" name="apellido" /><br /><br />
    <button type="submit">Actualizar Perfil</button>
  </form>

  <h2>Simulaci√≥n de Compra</h2>
  <label for="input-simbolo">S√≠mbolo de la Criptomoneda:</label><br />
  <input type="text" id="input-simbolo" placeholder="Ej: ripple" required /><br /><br />
  <label for="input-cantidad">Cantidad de crypto:</label><br />
  <input type="number" id="input-cantidad" placeholder="Ej: 100" required /><br /><br />
  <button id="btn-comprar">Comprar</button>

  <h3>Respuesta del servidor:</h3>
  <pre id="respuesta"></pre>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyCeFXdnnytQRyuXup6UO3Dj0VX1qXUyCXs",
      authDomain: "cryptotracker-717d2.firebaseapp.com",
      projectId: "cryptotracker-717d2",
      storageBucket: "cryptotracker-717d2.appspot.com",
      messagingSenderId: "122496075810",
      appId: "1:122496075810:web:3db6bc39ef64a03e75a27b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    auth.onAuthStateChanged(async user => {
      if (!user) {
        console.warn('Usuario no autenticado');
        return;
      }

	const token = localStorage.getItem("token");
	console.log("Token le√≠do de localStorage:", token);
	console.log("Header que env√≠o:", { Authorization: `Bearer ${token}` });
	
	fetch("/api/portafolios/me", {
	  method: "GET",
	  headers: {
	    "Accept": "application/json",
	    "Content-Type": "application/json",
	    "Authorization": `Bearer ${token}`
	  }
	})
	.then(r => r.json())
	.then(console.log)
	.catch(console.error);

      // 1) GET resumen del portafolio
      console.log('‚úàÔ∏è Llamando a /api/portafolios/me/resumen con token', token);
      let respResumen = await fetch("http://localhost:8080/api/portafolios/me/resumen", {
        headers: { "Authorization": "Bearer " + token }
      });
      console.log('üì∂ /resumen status:', respResumen.status);
      if (!respResumen.ok) {
        console.error("Error al obtener el resumen:", await respResumen.text());
      } else {
        const resumen = await respResumen.json();
        console.log("üè¶ Resumen:", resumen);
      }

      // 2) GET portafolio completo
      console.log('‚úàÔ∏è Llamando a /api/portafolios/me con token', token);
      let respPortafolio = await fetch("http://localhost:8080/api/portafolios/me", {
        headers: { "Authorization": "Bearer " + token }
      });
      console.log('üì∂ /me status:', respPortafolio.status);
      if (!respPortafolio.ok) {
        console.error("Error al obtener portafolio:", await respPortafolio.text());
      } else {
        const portafolio = await respPortafolio.json();
        console.log("üìã Portafolio:", portafolio);
      }

      // 3) Listener para comprar
      document.getElementById("btn-comprar").addEventListener("click", async (e) => {
        e.preventDefault();
        const simbolo = document.getElementById("input-simbolo").value.toLowerCase();
        const cantidadCrypto = parseFloat(document.getElementById("input-cantidad").value);
        if (isNaN(cantidadCrypto) || cantidadCrypto <= 0) {
          return alert("Cantidad inv√°lida");
        }

        // Precio actual
        let precio;
        try {
          precio = await obtenerPrecioActual(simbolo);
          console.log("üí∞ Precio recibido:", precio);
          if (!precio || isNaN(precio)) throw new Error("Precio inv√°lido");
        } catch (err) {
          return alert("Error al obtener el precio: " + err.message);
        }

        const compraRequest = {
          usuarioId: user.uid,
          simbolo,
          nombreCrypto: simbolo[0].toUpperCase() + simbolo.slice(1),
          cantidadCrypto,
          precio
        };
        console.log("üì§ Enviando compra:", compraRequest);

        // POST transacci√≥n
        const respCompra = await fetch("http://localhost:8080/api/transacciones/comprar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(compraRequest)
        });
        console.log('üì∂ /comprar status:', respCompra.status);
        const text = await respCompra.text();
        if (!respCompra.ok) {
          return alert("Error al comprar: " + respCompra.status + " " + text);
        }
        document.getElementById("respuesta").textContent = text;
      });

    });

    async function obtenerPrecioActual(simbolo) {
      try {
        const r = await fetch(`http://localhost:8080/api/cryptos/precio/${simbolo}`);
        if (!r.ok) throw new Error("No se pudo obtener el precio");
        const d = await r.json();
        return d.current_price ?? d;  // ajusta seg√∫n tu API
      } catch (e) {
        console.error("‚ùå obtenerPrecioActual:", e);
        return 0;
      }
    }
  });
  </script>
</body>
</html>
