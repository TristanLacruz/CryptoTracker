<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil - CryptoTracker</title>
</head>
<body>
  <h2>Editar Perfil</h2>
  <form id="perfilForm">
    <input type="hidden" id="userId" name="id" />
    <label for="nombreUsuario">Nombre de usuario:</label><br />
    <input type="text" id="nombreUsuario" name="nombreUsuario" required /><br /><br />
    <label for="email">Correo electr√≥nico:</label><br />
    <input type="email" id="email" name="email" /><br /><br />
    <label for="nombre">Nombre:</label><br />
    <input type="text" id="nombre" name="nombre" /><br /><br />
    <label for="apellido">Apellido:</label><br />
    <input type="text" id="apellido" name="apellido" /><br /><br />
    <button type="submit">Actualizar Perfil</button>
  </form>

  <h2>Simulaci√≥n de Compra</h2>
  <label for="input-simbolo">S√≠mbolo de la Criptomoneda:</label><br />
  <input type="text" id="input-simbolo" placeholder="Ej: ripple" required /><br /><br />
  <label for="input-cantidad">Cantidad de crypto:</label><br />
  <input type="number" id="input-cantidad" placeholder="Ej: 100" required /><br /><br />
  <button id="btn-comprar">Comprar</button>

  <h3>Respuesta del servidor:</h3>
  <pre id="respuesta"></pre>

<!-- SCRIPTS DE FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCeFXdnnytQRyuXup6UO3Dj0VX1qXUyCXs",
    authDomain: "cryptotracker-717d2.firebaseapp.com",
    projectId: "cryptotracker-717d2",
    storageBucket: "cryptotracker-717d2.appspot.com",
    messagingSenderId: "122496075810",
    appId: "1:122496075810:web:3db6bc39ef64a03e75a27b"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  async function obtenerPrecioActual(simbolo) {
  try {
    const response = await fetch(`http://localhost:8080/api/cryptos/precio/${simbolo}`);
    if (!response.ok) throw new Error("No se pudo obtener el precio");
    const data = await response.json();
    console.log("üì¶ Respuesta de precio:", data); // üëà √ötil para depurar
    return data; // üëà Este campo debe existir
  } catch (error) {
    console.error("‚ùå Error en obtenerPrecioActual:", error.message);
    return 0;
  }
}



  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      alert("No has iniciado sesi√≥n.");
      window.location.href = "firebase-login.html";
      return;
    }

    const token = await user.getIdToken();

    document.getElementById("btn-comprar").addEventListener("click", async () => {
      const simbolo = document.getElementById("input-simbolo").value.toLowerCase();
      const cantidadCrypto = parseFloat(document.getElementById("input-cantidad").value);

      if (isNaN(cantidadCrypto) || cantidadCrypto <= 0) {
        alert("Cantidad inv√°lida");
        return;
      }

   let precio = 0;
try {
  precio = await obtenerPrecioActual(simbolo);
  console.log("üí∞ Precio recibido:", precio); // üëà Lo ver√°s en consola
  if (!precio || isNaN(precio)) {
    throw new Error("Precio inv√°lido");
  }
} catch (e) {
  alert("Error al obtener el precio: " + e.message);
  return;
}



      const nombreCrypto = simbolo.charAt(0).toUpperCase() + simbolo.slice(1);

      const compraRequest = {
        usuarioId: user.uid,
        simbolo,
        nombreCrypto,
        cantidadCrypto,
        precio
      };

      console.log("üì§ Enviando compra:", compraRequest);

      try {
        const response = await fetch("http://localhost:8080/api/transacciones/comprar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify(compraRequest)
        });

        const responseText = await response.text();
        if (!response.ok) {
          throw new Error("Error al comprar: " + response.status + " " + responseText);
        }

        const resultado = JSON.parse(responseText);
        document.getElementById("respuesta").textContent = JSON.stringify(resultado, null, 2);

      } catch (err) {
        alert("Error al comprar: " + err.message);
      }
    });
  });
</script>

</body>
</html>
