<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Firebase Login</title>
<script
	src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script
	src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
</head>
<body>
	<h2>Iniciar sesi√≥n con Firebase</h2>

	<input type="email" id="email" placeholder="Email">
	<br>
	<br>
	<input type="password" id="password" placeholder="Password">
	<br>
	<br>
	<button onclick="login()">Login</button>

	<h3>ID Token:</h3>
	<pre id="token"></pre>
	<h3>Datos del usuario:</h3>
	<pre id="userData"></pre>


	<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCeFXdnnytQRyuXup6UO3Dj0VX1qXUyCXs",
    authDomain: "cryptotracker-717d2.firebaseapp.com",
    projectId: "cryptotracker-717d2",
    storageBucket: "cryptotracker-717d2.appspot.com",
    messagingSenderId: "122496075810",
    appId: "1:122496075810:web:3db6bc39ef64a03e75a27b",
    measurementId: "G-WBT5E5XXGC"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  window.login = async function () {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const tokenOutput = document.getElementById("token");
    const userDataOutput = document.getElementById("userData");

  console.log("üîë Iniciando login con:", email);

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
    console.log("‚úÖ Login exitoso con Firebase");      
const idToken = await userCredential.user.getIdToken();
    console.log("üì§ Token obtenido:", idToken);      
if (window.java && typeof window.java.receiveToken === "function") {
    window.java.receiveToken(idToken);
} else {
    console.error("‚ùå window.java no est√° disponible a√∫n");
}

      const response = await fetch("http://localhost:8080/auth/me/details", {
        method: "GET",
        headers: {
          Authorization: "Bearer " + idToken
        }
      });

    console.log("üì• Respuesta cruda:", response);

      if (!response.ok) throw new Error("No se pudo obtener el usuario");

		const userData = await response.json();
		userDataOutput.textContent = JSON.stringify(userData, null, 2);

    console.log("‚úÖ Usuario recibido:", userData);
		// üîÅ Redirigir al perfil tras login exitoso
		window.location.href = "perfil.html";

    } catch (error) {
    console.error("‚ùå Error en login o fetch:", error);
      tokenOutput.textContent = "‚ö†Ô∏è Error: " + error.message;
      userDataOutput.textContent = "";
    }
  }
</script>

</body>
</html>
